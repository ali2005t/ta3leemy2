<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>╪з┘Д╪е╪┤╪╣╪з╪▒╪з╪к - Ta3leemy Teacher</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="icon" href="../assets/images/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <header class="top-bar-redesigned"
                style="display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: #0f172a; border-bottom: 1px solid #1e293b;">
                <div class="header-right" style="display:flex; align-items:center; gap:15px;">
                    <button class="btn-icon mobile-only" id="open-sidebar"
                        style="background:transparent; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i
                            class="fas fa-bars"></i></button>
                    <div class="header-title" style="display:flex; align-items:center; gap:10px;">
                        <img src="../assets/images/logo.png" alt="Logo"
                            style="height:35px; border-radius:50%;">
                        <div>
                            <h3 style="margin:0; color:white; font-size:1.2rem;">╪е╪п╪з╪▒╪й ╪з┘Д╪е╪┤╪╣╪з╪▒╪з╪к</h3>
                            <p id="platform-name" style="margin:0; font-size:0.8rem; color:#94a3b8;">┘Е┘Ж╪╡╪к┘К ╪з┘Д╪к╪╣┘Д┘К┘Е┘К╪й</p>
                        </div>
                    </div>
                </div>
            </header>

            <div class="page-content">

                <!-- Tabs -->
                <div class="tabs-container"
                    style="display:flex; gap:10px; margin-bottom:2rem; border-bottom:1px solid #334155;">
                    <button class="tab-btn active" onclick="switchTab('inbox')" id="tab-inbox"
                        style="padding:10px 20px; background:transparent; border:none; color:white; border-bottom:2px solid #6366f1; cursor:pointer; font-weight:bold;">
                        <i class="fas fa-inbox"></i> ╪з┘Д┘И╪з╪▒╪п (┘Е┘Ж ╪з┘Д╪е╪п╪з╪▒╪й)
                    </button>
                    <button class="tab-btn" onclick="switchTab('sent')" id="tab-sent"
                        style="padding:10px 20px; background:transparent; border:none; color:#94a3b8; border-bottom:2px solid transparent; cursor:pointer; font-weight:bold;">
                        <i class="fas fa-paper-plane"></i> ╪з┘Д┘Е╪▒╪│┘Д (┘Д┘Д╪╖┘Д╪з╪и)
                    </button>
                </div>

                <!-- Inbox Section -->
                <div id="section-inbox" class="content-section">
                    <div class="content-card">
                        <div class="card-header"
                            style="padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin:0;">╪е╪┤╪╣╪з╪▒╪з╪к ╪з┘Д╪е╪п╪з╪▒╪й</h3>
                        </div>
                        <div class="table-container">
                            <div id="inbox-list" style="display:flex; flex-direction:column;">
                                <!-- JS Loaded -->
                                <div style="padding:2rem; text-align:center; color:#64748b;">
                                    <i class="fas fa-spinner fa-spin"></i> ╪м╪з╪▒┘К ╪з┘Д╪к╪н┘Е┘К┘Д...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sent Section (Existing) -->
                <div id="section-sent" class="content-section" style="display:none;">
                    <!-- Send New Notification -->
                    <div class="content-card" style="margin-bottom:2rem;">
                        <div class="card-header"
                            style="padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.05);">
                            <h3 style="margin:0;">╪е╪▒╪│╪з┘Д ╪е╪┤╪╣╪з╪▒ ╪м╪п┘К╪п</h3>
                            <p style="color:#64748b;">┘В┘Е ╪и╪е╪▒╪│╪з┘Д ╪к┘Ж╪и┘К┘З╪з╪к ┘Д╪╖┘Д╪з╪и┘Г ┘Д╪е╪и┘В╪з╪ж┘З┘Е ╪╣┘Д┘Й ╪з╪╖┘Д╪з╪╣.</p>
                        </div>
                        <div class="card-body">
                            <div class="form-group" style="margin-bottom:1.5rem;">
                                <label style="display:block; margin-bottom:0.5rem; color:#94a3b8;">╪╣┘Ж┘И╪з┘Ж ╪з┘Д╪е╪┤╪╣╪з╪▒</label>
                                <input type="text" id="notif-title" class="form-input"
                                    placeholder="┘Е╪л╪з┘Д: ┘Е╪н╪з╪╢╪▒╪й ╪м╪п┘К╪п╪й╪М ╪к┘Ж╪и┘К┘З ┘З╪з┘Е..."
                                    style="width:100%; padding:10px; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px;">
                            </div>
                            <div class="form-group" style="margin-bottom:1.5rem;">
                                <label style="display:block; margin-bottom:0.5rem; color:#94a3b8;">┘Ж╪╡ ╪з┘Д╪▒╪│╪з┘Д╪й</label>
                                <textarea id="notif-body" class="form-input" rows="3"
                                    placeholder="╪з┘Г╪к╪и ╪▒╪│╪з┘Д╪к┘Г ╪з┘Д╪м╪░╪з╪и╪й ┘З┘Ж╪з..."
                                    style="width:100%; padding:10px; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px; resize:vertical;"></textarea>
                            </div>
                            <button id="send-btn" class="btn"
                                style="background:#6366f1; color:white; border:none; padding:12px 30px; border-radius:8px; font-weight:bold; cursor:pointer;">
                                <i class="fas fa-paper-plane"></i> ╪е╪▒╪│╪з┘Д ╪з┘Д╪е╪┤╪╣╪з╪▒
                            </button>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="content-card">
                        <div class="card-header"
                            style="padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.05);">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 style="margin:0;">╪│╪м┘Д ╪з┘Д╪е╪┤╪╣╪з╪▒╪з╪к ╪з┘Д┘Е╪▒╪│┘Д╪й</h3>
                                <button id="teacher-delete-all-btn" onclick="deleteAllNotifications()"
                                    style="display:none; background:#ef4444; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.9rem;">
                                    <i class="fas fa-trash-alt"></i> ╪н╪░┘Б ╪з┘Д┘Г┘Д
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>╪з┘Д╪╣┘Ж┘И╪з┘Ж</th>
                                        <th>╪з┘Д┘Ж╪╡</th>
                                        <th>╪к╪з╪▒┘К╪о ╪з┘Д╪е╪▒╪│╪з┘Д</th>
                                        <th>╪з┘Д╪н╪з┘Д╪й</th>
                                    </tr>
                                </thead>
                                <tbody id="history-list">
                                    <tr>
                                        <td colspan="4" style="text-align:center; padding:20px;">╪м╪з╪▒┘К ╪з┘Д╪к╪н┘Е┘К┘Д...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initTeacherUI } from '../assets/js/teacher-ui.js?v=9.0';
        document.addEventListener('DOMContentLoaded', initTeacherUI);
        import { auth, db } from '../assets/js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, addDoc, query, where, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initHeader } from '../assets/js/header-manager.js';
        import { getEffectiveUserUid } from '../assets/js/impersonation-manager.js';
        import { PushService } from '../assets/js/push-service.js?v=4.0';

        let currentUid = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                initHeader(user);
                currentUid = await getEffectiveUserUid(user);
                if (currentUid) {
                    loadInbox();
                    loadHistory();
                }
            } else {
                window.location.href = '../auth/login.html';
            }
        });

        // Toggle Tabs
        window.switchTab = (tabName) => {
            // Reset
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.style.color = '#94a3b8';
                b.style.borderBottomColor = 'transparent';
                b.classList.remove('active');
            });
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');

            // Activate
            const btn = document.getElementById(`tab-${tabName}`);
            const section = document.getElementById(`section-${tabName}`);

            if (btn) {
                btn.classList.add('active');
                btn.style.color = 'white';
                btn.style.borderBottomColor = '#6366f1';
            }
            if (section) section.style.display = 'block';
        };

        // Load Inbox (Admin Messages)
        async function loadInbox() {
            const container = document.getElementById('inbox-list');
            if (!container) return;

            try {
                const q = query(
                    collection(db, "notifications"),
                    where("target", "in", ["all", "all_teachers", currentUid]),
                    orderBy("createdAt", "desc")
                );

                const snap = await getDocs(q);
                container.innerHTML = '';

                if (snap.empty) {
                    container.innerHTML = `
                        <div style="padding:4rem; text-align:center; opacity:0.6;">
                            <i class="fas fa-inbox fa-3x" style="margin-bottom:1rem;"></i>
                            <p>╪╡┘Ж╪п┘И┘В ╪з┘Д┘И╪з╪▒╪п ┘Б╪з╪▒╪║</p>
                        </div>
                    `;
                    return;
                }

                snap.forEach(doc => {
                    const n = doc.data();
                    const date = n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleString('ar-EG') : '-';
                    const icon = n.sender === 'admin' ? '<i class="fas fa-crown" style="color:#f59e0b;"></i>' : '<i class="fas fa-bell"></i>';

                    container.innerHTML += `
                        <div style="background:#0f172a; padding:1.5rem; border-radius:8px; margin-bottom:1rem; border:1px solid #334155; position:relative;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <h4 style="margin:0; font-size:1.1rem; color:white;">${icon} ${n.title}</h4>
                                <span style="font-size:0.8rem; color:#94a3b8;">${date}</span>
                            </div>
                            <p style="color:#cbd5e1; line-height:1.6; margin:0;">${n.body}</p>
                        </div>
                    `;
                });

            } catch (e) {
                console.error(e);
                // Fallback for missing index
                if (e.code === 'failed-precondition') {
                    console.log("Retry without OrderBy");
                    const q2 = query(collection(db, "notifications"), where("target", "in", ["all", "all_teachers", currentUid]));
                    // ... reuse render logic ...
                }
                container.innerHTML = '<p style="padding:20px; color:red; text-align:center;">╪н╪п╪л ╪о╪╖╪г ┘Б┘К ╪к╪н┘Е┘К┘Д ╪з┘Д╪▒╪│╪з╪ж┘Д</p>';
            }
        }

        // Send Logic
        document.getElementById('send-btn').onclick = async () => {
            const title = document.getElementById('notif-title').value;
            const body = document.getElementById('notif-body').value;
            const btn = document.getElementById('send-btn');

            if (!title || !body) return UIManager.showToast('┘К╪▒╪м┘Й ┘Е┘Д╪б ╪м┘Е┘К╪╣ ╪з┘Д╪н┘В┘И┘Д', 'warning');

            btn.disabled = true;
            btn.innerHTML = '╪м╪з╪▒┘К ╪з┘Д╪е╪▒╪│╪з┘Д...';

            try {
                await addDoc(collection(db, "notifications"), {
                    title: title,
                    body: body,
                    teacherId: currentUid,
                    target: 'all_students',
                    createdAt: serverTimestamp(),
                    isRead: false
                });

                // --- TRIGGER PUSH NOTIFICATION (BACKGROUND) ---
                try {
                    console.log("Triggering Push...");
                    const pushResult = await PushService.sendToTeacherStudents(currentUid, title, body);

                    if (!pushResult || !pushResult.success) {
                        const err = pushResult?.error || 'Unknown Error';
                        alert("╪к┘Е ╪з┘Д╪н┘Б╪╕╪М ┘И┘Д┘Г┘Ж ┘Б╪┤┘Д ╪з┘Д╪е╪┤╪╣╪з╪▒: " + err);
                    } else {
                        alert('╪к┘Е ╪з┘Д╪н┘Б╪╕ ┘И╪е╪▒╪│╪з┘Д ╪з┘Д╪е╪┤╪╣╪з╪▒ ╪и┘Ж╪м╪з╪н! ЁЯЪА');
                    }

                } catch (pushErr) {
                    console.error("Push Failed:", pushErr);
                    alert("╪о╪╖╪г ╪║┘К╪▒ ┘Е╪к┘И┘В╪╣: " + pushErr.message);
                }
                // ----------------------------------------------

                document.getElementById('notif-title').value = '';
                document.getElementById('notif-body').value = '';
                loadHistory();

            } catch (e) {
                console.error(e);
                alert('╪н╪п╪л ╪о╪╖╪г ╪г╪л┘Ж╪з╪б ╪з┘Д╪е╪▒╪│╪з┘Д');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> ╪е╪▒╪│╪з┘Д ╪з┘Д╪е╪┤╪╣╪з╪▒';
            }
        };

        // Load History
        async function loadHistory() {
            try {
                const q = query(
                    collection(db, "notifications"),
                    where("teacherId", "==", currentUid),
                    orderBy("createdAt", "desc")
                );
                const snap = await getDocs(q);
                const tbody = document.getElementById('history-list');
                const deleteAllBtn = document.getElementById('teacher-delete-all-btn');

                tbody.innerHTML = '';

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">┘Д╪з ╪к┘И╪м╪п ╪е╪┤╪╣╪з╪▒╪з╪к ╪│╪з╪и┘В╪й</td></tr>';
                    if (deleteAllBtn) deleteAllBtn.style.display = 'none';
                    return;
                }

                if (deleteAllBtn) deleteAllBtn.style.display = 'block';

                snap.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('ar-EG') : '-';

                    const row = `
                        <tr>
                            <td style="font-weight:bold;">${data.title}</td>
                            <td>${data.body}</td>
                            <td>${date}</td>
                            <td>
                                <span class="badge" style="background:#10b981; color:white; padding:2px 8px; border-radius:4px;">╪к┘Е ╪з┘Д╪е╪▒╪│╪з┘Д</span>
                                <button onclick="deleteNotification('${doc.id}')" style="background:none; border:none; color:#ef4444; cursor:pointer; margin-right:10px;" title="╪н╪░┘Б">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (e) {
                console.error("Error loading history:", e);
            }
        }

        // Delete Logic
        import { deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.deleteNotification = async (id) => {
            if (!confirm("┘З┘Д ╪г┘Ж╪к ┘Е╪к╪г┘Г╪п ┘Е┘Ж ╪н╪░┘Б ┘З╪░╪з ╪з┘Д╪е╪┤╪╣╪з╪▒ ┘Е┘Ж ╪з┘Д╪│╪м┘Д╪Я")) return;
            try {
                await deleteDoc(doc(db, "notifications", id));
                loadHistory(); // Refresh
            } catch (e) {
                console.error("Delete failed", e);
                alert("┘Б╪┤┘Д ╪з┘Д╪н╪░┘Б");
            }
        };

        window.deleteAllNotifications = async () => {
            if (!confirm("тЪая╕П ╪к╪н╪░┘К╪▒: ┘З┘Д ╪г┘Ж╪к ┘Е╪к╪г┘Г╪п ┘Е┘Ж ╪н╪░┘Б ┘Г╪з┘Б╪й ╪е╪┤╪╣╪з╪▒╪з╪к┘Г╪Я")) return;

            const btn = document.getElementById('teacher-delete-all-btn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const q = query(
                    collection(db, "notifications"),
                    where("teacherId", "==", currentUid)
                );
                const snapshot = await getDocs(q);
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                alert("╪к┘Е ╪н╪░┘Б ╪з┘Д╪│╪м┘Д ╪и┘Ж╪м╪з╪н");
                loadHistory();

            } catch (e) {
                console.error(e);
                alert("┘Б╪┤┘Д ╪н╪░┘Б ╪з┘Д┘Г┘Д");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        };



        // Scripts from global-ui handle toggles now.

    </script>
</body>

</html>
